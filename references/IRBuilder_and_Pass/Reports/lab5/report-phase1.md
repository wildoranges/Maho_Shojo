# Lab5 实验报告-阶段一
曾源 PB18111741
黄庄湫 PB18111719

## 实验要求

本次实验第一阶段主要是阅读`LoopSearch`与`Mem2Reg`相关代码与文档。掌握通过对LightIR接口的调用以及CFG的分析开发优化pass的方法。
对于`LoopSearch`,需要理解优化对于循环的处理,为阶段二循环不变式外提等优化做准备,并回答思考题.
对于`Mem2Reg`,需要理解CFG以及支配树的结构,了解半剪枝构造SSA形式中间代码的相关知识,能够描述优化的基本流程,并回答思考题.

## 思考题
### LoopSearch
1. 循环的入口如何确定？循环的入口的数量可能超过1嘛？
>$\quad$循环的入口在`find_loop_base(*set,&reserved)`中得到。其中set为当前CFG经过Tarjan算法后得到的强连通分量集合中的一个元素，而reserved则是通过先前的步骤清除外层循环入口结点后保留下的循环入口集合。
>$\quad$首先函数会对set中的结点进行寻找，并且选择满足条件的结点作为该强连通分量（循环）的入口结点，而满足的条件为结点存在不属于该连通分量的前驱结点。
>$\quad$倘若这种结点不存在，则说明该连通分量的所有结点的所有前驱都包含在该分量中，此时`find_loop_base(*set,&reserved)`将对reserved集合中的结点（即先前分析保留的入口结点）遍历其后继，并且选择存在于该连通分量中的后继结点作为该连通分量的入口结点。
>$\quad$循环的入口的数量不可能超过1。因为在Cminusf的语法中没有goto语句，所有的循环都只能由while产生，故循环的入口只能是condition所在块，所以循环的入口数目不可能超过1。
>$\textbf{P.S.}$如果是一般图的强连通分量，理论上存在多个入口的可能，但`find_loop_base(*set,&reserved)`只会在其中选取一个作为入口结点。因为算法在删除入口结点以及与之相连的结点的前驱后继关系时，会破坏该连通分量，这意味着每个强连通分量只会被分析一次，而每次分析只会选择最后一个满足条件的结点作为入口结点。入口结点的选择取决于迭代器中元素的顺序，并且入口结点的选择还会影响后续内循环的分析。
2. 简述一下算法怎么解决循环嵌套的情况。
> $\quad$算法是通过不断删除入口结点来由外到内地分析循环的。由1中的解释，在删去入口结点时会破坏连通分量（即破坏了外层循环），随后形成的新CFG在执行Tarjan算法后会得到一个或多个内循环，从而实现了由外到内的嵌套循环分析。
### Mem2Reg
1. 请简述支配边界的概念。
>对于CFG中的结点n和m,如果结点n支配结点m的一个前趋,但n并不严格支配m,则m属于n的支配边界.满足前述条件的结点m的集合即为n的支配边界。
>用非正式的话来说，n的支配边界是离开n的每条路径上，从n可达但不被n支配的第一个点的集合。
2. 请简述`phi`节点的概念，与其存在的意义
>`phi`节点是一条指令,用于根据当前块的前趋选择一个值.
>`phi`存在的意义在于构造程序的SSA形式。为了达成这一目的，编译器必须向CFG中的汇合点处选择性的插入`phi`函数,并进行变量和临时值的重命名,使之符合支配SSA形式名字空间的规则.
3. 请描述`Mem2Reg Pass`执行前后的ir的变化, 简述一下 
>`Mem2Reg Pass`执行后,对于gcd()函数,任何关于参数的引用及相关操作(alloca,load和store)都被替换.对于main()函数,不再为调用函数的返回值开辟空间,而在后续对该返回值的引用都用存储该返回值的寄存器替换.在label14中,使用`phi`函数,根据当前块的前趋选择先前IR（未执行`Mem2Reg Pass`）中地址\%op2,\%op1,\%op0中存储的值,并替换其余各处对于以上三个地址中存储的值的引用.
4. 在放置`phi`节点的时候，算法是如何利用支配树的信息的？
>放置`phi`节点时,算法会根据结点的支配边界来更精确地判断放置`phi`节点的位置,而结点的支配边界则通过支配树所维护的信息计算得出。
5. 算法是如何选择`value`(变量最新的值)来替换`load`指令的？（描述数据结构与维护方法）
>算法维护了一个map,该map将变量名映射到一个栈,栈中存储该变量的值,栈顶即为该变量当前最新的值.每当扫描到`load`指令时,若该`load`指令的左值既不是全局变量也不是一个地址,并且该左值对应的栈非空,则使用栈顶的值(即该变量最新的值)替换该`load`指令

### 代码阅读总结

此次实验让我们了解了循环优化以及通过支配边界构造半剪枝SSA形式中间代码的相关知识,让我们对SSA形式本身的生成过程和代码优化有了更深入的理解,为之后调用`LightIR`接口开发优化Pass做准备.

### 实验反馈 （可选 不会评分）

1. [LoopSearch.cpp](../../src/optimization/LoopSearch.cpp)中:
 * LINE 193-203 与 LINE 205-211的循环是相同且冗余的
 * Bool hasBeen 没有被使用到

2. 希望助教能在代码中提供更多注释,帮助同学们加深对算法的理解

### 组间交流 （可选）

无
